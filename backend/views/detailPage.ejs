<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>작심삼일</title>
    <link rel="stylesheet"  href="/css/style_detailPage.css" />
    <link rel="stylesheet"  href="/css/main.css" />
    <link rel="stylesheet"  href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" />
  </head>
  <!-- header부분은 수정하지 않음, 카테고리 list도 추후 수정 -->
  <body>
    <%   function getTodayDate() { %>
    <%    var date = new Date(); %>
    <%    var year = date.getFullYear(); %>
    <%   var month = ("0" + (1 + date.getMonth())).slice(-2); %>
    <%   var day = ("0" + date.getDate()).slice(-2); %>
    <%  return year + "-" + month + "-" + day; %>
    <%    } %>

    <div class="detailPageListAll">
      <div class="challengeTitle">
        <div class="postCategory"><div><%= challenge.category %></div></div>
      </div>
      <div class="challengeTitle">
        <h1><%= challenge.title %></h1>
      </div>
      <div class="challengeTitle">
        <div class="creator">
          <!-- 유저이미지는 추후 추가할것 -->
          <span class="creatorIcon"></span>
          <span class="creatorName"><%= challenge.author.name %></span>
        </div>
    
      </div>
      

      <div class="detailPostImg"> 
        <img src="data:challenge/<%=challenge.img.contentType%>;base64,
        <%=challenge.img.data.toString('base64')%>">
      </div>

        <% if(challenge.joinusers.length===0 || !challenge.joinusers.includes(user.id) ){ %>
        <aside class="registerChallenge">
              <div class="registerDateTitle">
                <div>
                  <!-- 나중에 YYYY-MM-DD 형식으로 변환할 것 -->
                  <span class="startDateTxt">시작일</span>
                  <div class="startDate"><%= challenge.startdate %></div>
                  <span>종료일</span>
                  <div class="endDate"><%= challenge.enddate %></div>
                </div>
              </div>
              <div class="registerDateTitle">
                
                  <% if((challenge.startdate)<getTodayDate()) { %>
                  <button class="registerForbiddenButton">챌린지 신청 기간이 지났습니다</button>
                

                    <% }else { %>
                    <form
                    method="post"
                    enctype="multipart/form-data"
                    action= <%= challenge.shortId+"/join" %>
                    >
                    <input
                        type="submit"
                        id="create_submit"
                        name="create_submit"
                        class="registerButton"
                        value="참여하기"
                      />
                    </form>
                  <% } %>
              </div>
        </aside>
        <% }else{ %>
          <aside class="attendChallenge">
          <div class="challengeTitle">
            <div class="progressTxt">진행 상황</div>
          </div>
          <div class="challengeTitle">
            <input class="calendar" />
          </div>
          <div class="challengeTitle">  
            <%if((challenge.startdate)>getTodayDate()){ %>
              <button class="registerForbiddenButton"><%= Number(challenge.startdate.slice(5,7))%>월 <%=Number(challenge.startdate.slice(8,10))%>일 부터 시작합니다!</button>        
              <%} else if((challenge.enddate)<getTodayDate()){ %>
            
                <button class="registerForbiddenButton">챌린지 기간이 끝났습니다</button>        

              <%} else if(attendance.map(v=>v.attendanceDate).includes(getTodayDate())){ %>
            <button class="registerForbiddenButton">오늘 목표를 달성하셨습니다</button>
            <% }else{ %>
            <form
            method="post"
            enctype="multipart/form-data"
            action= <%= challenge.shortId+"/attendance" %>
        >
        <input
            type="submit"
            id="create_submit"
            name="attendancedate"
            class="attendButton"
            value= "출석하기"
          />
        </form>
        <% } %>
          </div>
        </aside>
          <% } %>

     

   

        <div class="divideLayerMiddle"></div>

        <div class="challengeTxt">
        챌린지 소개
        <div class="storyContent"><%= challenge.description %></div>
      </div>

      <div class="reviewWrite">후기</div>
     

    
      <!-- comment부분이 확정된 이후에 수정 -->
      <div class="reviewListBoard">
        <div class="createCard">
          후기를 등록해보세요!
          <div class="createCardLink"><a href="">후기 쓰기</a></div>
        </div>
        <% if(challenge.comments !=="") { %>
        <% for(let q=0; q<challenge.comments.length; q++) { %>
          <div class="reviewCard">
            <span class="reviewIcon">icon</span>
            <span class="reviewWriteUser"><% challenge.comments[q].author %></span>
            <div class="reviewText"><% challenge.comments[q].content %></div>
          </div>
        <% } %>
      </div>
    <% } %>
 
      </div>
    </div>
    <div class="detailPageMargin"></div>
    <div class="line"></div>
    <div class="detailPageModal">
      <div class="detailPageModalBody">챌린지를 모두 완료하셨습니다! 축하합니다!</div>

    </div>


  </body>
 <!-- footer영역 -->
  <script>
    var thisAttendDate = `<%= attendance.map(v=>v.attendanceDate) %>`
  var thisPageInfo= `<%= challenge.shortId %>`;
  var thisStartDate= `<%= challenge.startdate %>`;
  var thisEndDate= `<%= challenge.enddate %>`;
  </script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="/js/detailPage.js"></script>

    </html>
